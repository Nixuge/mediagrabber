<!DOCTYPE html>
<html>

<head>
    <title>Mediagrabber - index</title>
    <meta charset="UTF-8">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700" rel="stylesheet">
</head>

<body>
    <div class="split download">
        <div class="centered downloadDiv">
            <h1>MediaGrabber</h1>
            <h1>A simple iOS shortcut to download videos from the internet</h1>
            <a class="button biggerfont" href="https://www.icloud.com/shortcuts/d6f0262d29dc43f9b647455113d43699">
                <div id="latestButton" class="innerbutton expandOutElement">Download latest version</div>
            </a>

            <div id="legacyReleases" class="biggerfont">
                <div class="releaseTableView">
                    <span class="releaseVersion">v2.1.3</span>
                    <span class="releaseDate">(03/09/2022)</span>
                    <a class="button right" href="https://www.icloud.com/shortcuts/d6f0262d29dc43f9b647455113d43699">
                        <div class="innerbutton noanimation">Download</div>
                    </a>
                    <ul>
                        <li>Updated yt-dlp (2022.5.18 -> 2022.9.1)</li>
                    </ul>
                </div>

                <hr class="solid">

                <div class="releaseTableView">
                    <span class="releaseVersion">v2.1.2</span>
                    <span class="releaseDate">(16/06/2022)</span>
                    <a class="button right" href="https://www.icloud.com/shortcuts/d6f0262d29dc43f9b647455113d43699">
                        <div class="innerbutton noanimation">Download</div>
                    </a>
                    <ul>
                        <li>Big server changes:
                            <ul>
                                <li><b>REMOVED LEGACY V1 SUPPORT ON THE SERVER</b></li>
                                <li>File cleaner<ul>
                                        <li>
                                            Before, the downloaded videos just stayed on the server indefinitely until I
                                            deleted them manually, now they have an expiration date and get deleted
                                            after 60s
                                        </li>
                                    </ul>
                                </li>
                                <li>Updated yt-dlp (2022.4.8 -> 2022.5.18)</li>
                                <li>Proper logging</li>
                                <li>Removed unused dependency</li>
                                <li>Refactor</li>
                            </ul>
                        </li>
                    </ul>
                </div>

                <hr class="solid">

                <div class="releaseTableView">
                    <span class="releaseVersion">v2.1.1</span>
                    <span class="releaseDate">(15/06/2022)</span>
                    <a class="button right" href="https://www.icloud.com/shortcuts/c132b3146d5b479ba9f6d46043d0071e">
                        <div class="innerbutton noanimation">Download</div>
                    </a>
                    <ul>
                        <li>Server changes: <ul>
                                <li>"dont_retry_as_mkv" header</li>
                                <li>"format_extension" header</li>
                                <li>Better handling of some cases (GIFs)</li>
                            </ul>
                        </li>
                    </ul>
                </div>

                <hr class="solid">

                <div class="releaseTableView">
                    <span class="releaseVersion">v2.1</span>
                    <span class="releaseDate">(13/06/2022)</span>
                    <a class="button right" href="https://www.icloud.com/shortcuts/c233272f20e14a4cb37d084744591ad5">
                        <div class="innerbutton noanimation">Download</div>
                    </a>
                    <ul>
                        <li>API version bump</li>
                        <li>Now using changeable vars for the URLs</li>
                        <li>Version check</li>
                        <li>Fixed endpoints (2.0->2.1)</li>
                        <li>Fixed save for other formats</li>
                        <li>Added an option to input a custom format to save</li>
                    </ul>
                </div>

                <hr class="solid">

                <div class="releaseTableView">
                    <span class="releaseVersion">v2.0.1</span>
                    <span class="releaseDate">(09/06/2022)</span>
                    <a class="button right" href="https://www.icloud.com/shortcuts/c132b3146d5b479ba9f6d46043d0071e">
                        <div class="innerbutton noanimation">Download</div>
                    </a>
                    <ul>
                        <li>Hotfix for new URLs</li>
                    </ul>
                </div>

                <hr class="solid">

                <div class="releaseTableView">
                    <span class="releaseVersion">v2.0</span>
                    <span class="releaseDate">(08/06/2022)</span>
                    <a class="button right" href="https://www.icloud.com/shortcuts/70e4ab2ae07249a7bc52a346beae4a9c">
                        <div class="innerbutton noanimation">Download</div>
                    </a>
                    <ul>
                        <li>Initial rewrite</li>
                    </ul>
                </div>

                <hr class="solid">

                <div class="releaseTableView">
                    <span class="releaseVersion">v1.0</span>
                    <a class="button right">
                        <div class="innerbutton noanimation unavailable">Download</div>
                    </a>
                    <ul>
                        <li>Initial release</li>
                    </ul>
                </div>
            </div>
            <div class="bottom_buttons">

                <a class="button" href="https://github.com/sayem314">
                    <div class="innerbutton expandOutElement">Original</div>
                </a>
                <a class="button" href="https://github.com/yt-dlp/yt-dlp/blob/master/supportedsites.md">
                    <div class="innerbutton expandOutElement">Supported sites</div>
                </a>
                <a class="button" href="https://nixuge.me">
                    <div class="innerbutton expandOutElement">Main website</div>
                </a>

            </div>
            <div class="bottom_buttons">
                <a class="button" href="https://github.com/nixuge/mediagrabber">
                    <div class="innerbutton expandOutElement">Server source</div>
                </a>
                <a class="button" href="/doc">
                    <div class="innerbutton expandOutElement">API documentation</div>
                </a>
            </div>

        </div>
    </div>


    <div class="split directdl">
        <div class="centered directDiv">
            <h1>Direct download</h1>
            <h1>Enter a link below to download it</h1><br>

            <input id="urlinput" class="biggerfont textinput" type="text"><br>

            <a class="button biggerfont" onclick="show_results()">
                <div id="latestButton" class="innerbutton expandOutElement">Download</div>
            </a><br>

            <div class="biggerfont" id="quality_result"></div>
            <div id="loading" style="display: none;"></div>
        </div>
    </div>
</body>

<style global>
    @media only screen and (min-width: 1000px) {
        .split {
            height: 100%;
            width: 50%;
            position: fixed;
            z-index: 1;
            top: 10;
            overflow-x: hidden;
            padding-top: 20px;
        }

        .download {
            left: 0;
        }

        .directdl {
            right: 0;
        }
    }

    @media only screen and (max-width: 1000px) {
        .directdl {
            padding-top: 100px;
        }
    }

    .centered>*>*,
    .centered>*,
    .centered {
        height: auto;
        margin: 0 auto;
        padding: 10px;
        position: relative;
        text-align: center;
    }

    * {
        font-family: -apple-system-font, BlinkMacSystemFont, Open Sans, Helvetica Neue, Helvetica, Arial, sans-serif;
        color: var(--tint-text-color);
        margin: 0;
        /* would be better in a body tag tbh */
    }

    html {
        background-color: #111;
        --tint-color: #CA3D02;
        --tint-color-low: #a23100;
        --tint-color-fade: #6B2607;
        --semi-bold: 600;
        --tint-text-color: #FFF;
        --tint-text-color-fade: #CCBBB3;
    }

    .right {
        position: absolute;
        right: 0px;
    }

    .left {
        position: absolute;
        left: 0px;
    }

    .biggerfont {
        font-size: 120%;
    }

    .biggestfont {
        font-size: 250%;
    }

    hr.solid {
        border: 0;
        border-top: 1px solid #303436;
    }
</style>
<style buttons>
    /* partially from unc0ver.dev */
    .expandOutElement {
        animation-fill-mode: forwards;
        -webkit-animation-fill-mode: forwards;
        -webkit-animation: expandOut 1.6s;
        animation: expandOut 1.6s;
    }

    .button {
        text-decoration: none;
        display: inline-block;
    }

    .innerbutton {
        cursor: pointer;
        color: var(--tint-text-color);
        /* margin-top: 100px; */
        border-radius: 100px;
        padding: 15px 20px 15px 20px;
        font-weight: var(--semi-bold);
        background-color: var(--tint-color);
        max-width: 150px;
        transition: padding .15s ease;
        -webkit-transition: padding .15s ease;
        -moz-transition: padding .15s ease;
        -o-transition: padding .15s ease;
        -ms-transition: padding .15s ease;
    }

    .unavailable {
        background-color: var(--tint-color-fade);
        color: var(--tint-text-color-fade);
        cursor: not-allowed;
    }

    .innerbutton:hover {
        padding-left: 35px;
        padding-right: 35px;
    }

    .noanimation:hover {
        padding-left: 20px;
        padding-right: 20px;
    }
</style>
<style ios>
    /* Old releases */
    #legacyReleases {
        border-radius: 5px;
        display: block;
        height: 55vh;
        overflow: auto;
        margin-top: 2vh;
        margin-bottom: 2vh;
        border: 3px solid var(--tint-color);
    }

    .releaseTableView {
        padding-right: 120px;
        text-align: left;
    }

    .releaseVersion {
        text-decoration: underline;
    }

    .bottom_buttons {
        border-radius: 10px;
        background-color: #1a1a1a;
        display: inline-flex;
        margin-bottom: 20px;
    }
</style>
<style directdl>
    #quality_result,
    .result {
        text-align: left;
    }

    .textinput {
        /* could be in global but only used in ddl part */
        width: 90%;
        background: #111;
        color: #FFF;
        border: 3px solid var(--tint-color);
        border-radius: 10px;
    }
</style>
<style loading>
    /* from https://loading.io/css */
    @keyframes lds-dual-ring {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    #loading {
        display: inline-block;
        width: 80px;
        height: 80px;
    }

    #loading:after {
        content: " ";
        display: block;
        width: 64px;
        height: 64px;
        margin: 8px;
        border-radius: 50%;
        border: 6px solid;
        border-color: #FFF transparent #FFF transparent;
        animation: lds-dual-ring 1.2s linear infinite;
    }
</style>


<script>
    const all_qualities_api = '/api/{{ current_api_version }}/get_all_qualities';
    const best_qualities_api = '/api/{{ current_api_version }}/get_best_qualities';
    const download_api = '/api/{{ current_api_version }}/get_video';

    const result_element = document.getElementById("quality_result");


    function toggle_element(id, display_style) {
        if (typeof display_style === "undefined") {
            display_style = "block";
        }

        let elem = document.getElementById(id)
        if (elem.style.display == "none") {
            elem.style.display = display_style;
        } else {
            elem.style.display = "none";
        }
    }


    async function download_video_id(requested_url, id) {
        toggle_element("loading");
        toggle_element("quality_result");

        const headers_dict = {
            'format_extension': 'mkv',
            'url': requested_url,
            'id': id
        };

        fetch(download_api, { headers: headers_dict })
            .then(res => res.blob())
            .then(blob => {
                const file = window.URL.createObjectURL(blob);
                window.location.assign(file);
                toggle_element("loading");
                toggle_element("quality_result");
            });
    }


    async function fetch_url_header(api_url, requested_url) {
        return await fetch(api_url, {
            headers: {
                'Content-Type': 'application/json',
                'Content-type': 'text/json; charset="utf-8"',
                'url': requested_url
            }
        });
    }


    async function show_results() {
        // Reset the bottom part
        toggle_element("loading");
        result_element.innerHTML = "";

        // Request the provided link
        const requested_url = document.getElementById("urlinput").value;

        const best_results = await fetch_url_header(best_qualities_api, requested_url);

        // Doesn't need to go further if link invalid
        if (!best_results.ok) {
            result_element.innerHTML = "Invalid link.";
            result_element.className = "biggestfont";
            result_element.style.color = "#e70606";
            result_element.style.textAlign = "center";
            toggle_element("loading");
            return;
        }
        const results_json = await best_results.json();


        // If the code reaches here, the link is valid, so it displays all options.
        // Good old manual string building
        for (result in results_json) {
            if (result == "See all formats") continue;

            const id = results_json[result]["value"];

            result_element.innerHTML += `<div class='result'>
                <a class='button' onclick='download_video_id(\"${requested_url}\", \"${id}\")'>
                    <div class='innerbutton noanimation'>Download</div>
                </a>
                <label>${result}</label>`;
        }
        result_element.innerHTML += `<div id="showmore" style='text_align: center;'>
                <a class='button' onclick='show_more_results()'>
                    <div class='innerbutton'>See more formats?</div>
                </a>`;
        
        toggle_element("loading");
    }

    async function show_more_results() {
        toggle_element("showmore");
        toggle_element("loading");
        const requested_url = document.getElementById("urlinput").value;
        const all_result = await (await fetch_url_header(all_qualities_api, requested_url)).json();

        // document.getElementById("showmore").re
        for (result in all_result) {
            if (result == "Choose custom value") continue;
            const resolution = result.match("\\) (.*)")[1]
            console.log(result);
            console.log(resolution);
        }

        toggle_element("loading");
       
    }
</script>

</html>


</div>